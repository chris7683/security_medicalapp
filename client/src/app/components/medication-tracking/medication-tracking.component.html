<div class="container" @fadeIn>
  <h2>Medication Tracking</h2>
  <mat-card @fadeIn>
    <table mat-table [dataSource]="medications">
      <ng-container matColumnDef="patient">
        <th mat-header-cell *matHeaderCellDef>Patient</th>
        <td mat-cell *matCellDef="let m">{{ m.Patient?.name || 'N/A' }}</td>
      </ng-container>
      <ng-container matColumnDef="medication">
        <th mat-header-cell *matHeaderCellDef>Medication</th>
        <td mat-cell *matCellDef="let m">{{ m.name }}</td>
      </ng-container>
      <ng-container matColumnDef="dosage">
        <th mat-header-cell *matHeaderCellDef>Dosage</th>
        <td mat-cell *matCellDef="let m">{{ m.dosage }}</td>
      </ng-container>
      <ng-container matColumnDef="frequency">
        <th mat-header-cell *matHeaderCellDef>Frequency</th>
        <td mat-cell *matCellDef="let m">{{ m.frequency }}</td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let m">
          <span class="status-badge" [class.given]="m.tracking?.status === 'given'" [class.missed]="m.tracking?.status === 'missed'" [class.pending]="!m.tracking || m.tracking?.status === 'pending'">
            {{ m.tracking?.status || 'pending' | titlecase }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let m">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="markAsGiven(m.id)" 
            style="margin-right: 8px;"
            [disabled]="!m.id"
          >
            Mark as Given
          </button>
          <button 
            mat-raised-button 
            color="warn" 
            (click)="markAsMissed(m.id)"
            [disabled]="!m.id"
          >
            Mark as Missed
          </button>
          <!-- Debug info -->
          <small *ngIf="!m.id" style="color: red; display: block; margin-top: 4px;">
            Error: Medication ID missing ({{ m | json }})
          </small>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <p *ngIf="medications.length === 0" style="padding: 24px; text-align: center; color: #666;">
      No medications assigned to your patients.
    </p>
  </mat-card>
</div>
