<div class="container" @fadeIn>
  <h2>Patients</h2>
  <mat-card @fadeIn>
    <table mat-table [dataSource]="patients">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let p">{{ p.name }}</td>
      </ng-container>
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Age</th>
        <td mat-cell *matCellDef="let p">{{ p.age }}</td>
      </ng-container>
      <ng-container matColumnDef="condition" *ngIf="userRole === 'doctor'">
        <th mat-header-cell *matHeaderCellDef>Condition</th>
        <td mat-cell *matCellDef="let p">
          <div class="condition-cell">
            <!-- Edit mode for doctors -->
            <div *ngIf="isEditingCondition(p.id)" class="condition-edit">
              <mat-form-field appearance="outline" class="condition-input">
                <input
                  matInput
                  [(ngModel)]="conditionValues[p.id]"
                  placeholder="Enter condition"
                  (keyup.enter)="saveCondition(p.id)"
                  (keyup.escape)="cancelEditingCondition(p.id)"
                />
              </mat-form-field>
              <div class="condition-actions">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="saveCondition(p.id)"
                  matTooltip="Save condition"
                >
                  <mat-icon>check</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="cancelEditingCondition(p.id)"
                  matTooltip="Cancel"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
            <!-- View mode for doctors -->
            <div *ngIf="!isEditingCondition(p.id)" class="condition-view">
              <span class="condition-text" [class.no-condition]="!p.condition || p.condition === 'N/A'">
                {{ p.condition || 'N/A' }}
              </span>
              <div class="condition-buttons">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="startEditingCondition(p.id)"
                  matTooltip="Edit condition"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  *ngIf="p.condition && p.condition !== 'N/A'"
                  mat-icon-button
                  color="warn"
                  (click)="deleteCondition(p.id)"
                  matTooltip="Delete condition"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </td>
      </ng-container>
      <ng-container matColumnDef="nurse" *ngIf="userRole === 'doctor'">
        <th mat-header-cell *matHeaderCellDef>Assigned Nurse</th>
        <td mat-cell *matCellDef="let p">
          <div class="nurse-assignment">
            <mat-form-field appearance="outline" class="nurse-select">
              <mat-label>Select Nurse</mat-label>
              <mat-select
                [value]="p.assignedNurseId ? p.assignedNurseId.toString() : ''"
                (selectionChange)="assignNurse(p.id, $event.value)"
                [disabled]="nurses.length === 0 || nursesLoading"
              >
                <mat-option value="">None</mat-option>
                <mat-option *ngFor="let n of nurses" [value]="n.id ? n.id.toString() : ''">
                  {{ n.username || 'Unknown' }} ({{ n.email || 'No email' }})
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="nursesLoading">Loading nurses...</mat-hint>
              <mat-hint *ngIf="!nursesLoading && nurses.length === 0" class="error-hint">
                ⚠️ No nurses found. Check console for errors.
              </mat-hint>
              <mat-hint *ngIf="!nursesLoading && nurses.length > 0">
                {{ nurses.length }} nurse(s) available
              </mat-hint>
            </mat-form-field>
            <div *ngIf="p.assignedNurseId" class="assigned-nurse-label">
              <span class="assigned-info">
                Currently assigned: <strong>{{ getNurseName(p.assignedNurseId) }}</strong>
              </span>
            </div>
            <!-- Debug info - remove in production -->
            <small style="color: #999; font-size: 0.75rem;">
              Nurses: {{ nurses.length }} | Loading: {{ nursesLoading }} | Loaded: {{ nursesLoaded }}
            </small>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
    <p *ngIf="patients.length === 0" style="padding: 24px; text-align: center; color: #666;">
      No patients found.
    </p>
  </mat-card>
</div>
