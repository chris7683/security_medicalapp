<div class="container" @fadeIn>
  <h2>Admin Dashboard</h2>

  <mat-card class="section" @fadeIn>
    <h3>Users Management</h3>
    <button mat-raised-button color="primary" (click)="showCreateForm = !showCreateForm">
      {{ showCreateForm ? 'Cancel' : 'Create User' }}
    </button>

    <form *ngIf="showCreateForm" [formGroup]="createForm" (ngSubmit)="createUser()" class="form">
      <mat-form-field appearance="outline">
        <mat-label>Username</mat-label>
        <input matInput formControlName="username" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" type="email" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Password</mat-label>
        <input matInput formControlName="password" type="password" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Role</mat-label>
        <mat-select formControlName="role">
          <mat-option value="admin">Admin</mat-option>
          <mat-option value="doctor">Doctor</mat-option>
          <mat-option value="nurse">Nurse</mat-option>
          <mat-option value="patient">Patient</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="createForm.invalid">Create</button>
    </form>

    <table mat-table [dataSource]="users" class="mat-elevation-z1">
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let u">{{ u.id }}</td>
      </ng-container>
      <ng-container matColumnDef="username">
        <th mat-header-cell *matHeaderCellDef>Username</th>
        <td mat-cell *matCellDef="let u">{{ u.username }}</td>
      </ng-container>
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let u">{{ u.email }}</td>
      </ng-container>
      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef>Role</th>
        <td mat-cell *matCellDef="let u">{{ u.role }}</td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let u" class="actions-cell">
          <button mat-raised-button color="warn" (click)="deleteUser(u.id)">Delete</button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </mat-card>

  <mat-card class="section" @fadeIn>
    <h3>Patient Assignments</h3>
    <p *ngIf="patients.length === 0" class="info-text">No patients found. Create patient users first.</p>
    <p *ngIf="getDoctors().length === 0" class="warning-text">⚠️ No doctors found. Create doctor users first to assign them to patients.</p>
    
    <table *ngIf="patients.length > 0" mat-table [dataSource]="patients" class="mat-elevation-z1">
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let p">{{ p.id }}</td>
      </ng-container>
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Patient Name</th>
        <td mat-cell *matCellDef="let p">{{ p.name }}</td>
      </ng-container>
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Age</th>
        <td mat-cell *matCellDef="let p">{{ p.age }}</td>
      </ng-container>
      <ng-container matColumnDef="doctor">
        <th mat-header-cell *matHeaderCellDef>Assigned Doctor</th>
        <td mat-cell *matCellDef="let p" class="assignment-cell">
          <div *ngIf="getDoctors().length > 0" class="assignment-controls">
            <mat-form-field appearance="outline" style="width: 200px;">
              <mat-label>Select Doctor</mat-label>
              <mat-select [value]="p.assignedDoctorId ? p.assignedDoctorId.toString() : ''" (selectionChange)="assignDoctor(p.id, $event.value)">
                <mat-option [value]="''">-- None --</mat-option>
                <mat-option *ngFor="let d of getDoctors()" [value]="d.id.toString()">
                  {{ d.username }} ({{ d.email }})
                </mat-option>
              </mat-select>
            </mat-form-field>
            <span *ngIf="p.assignedDoctorId" class="assigned-info">
              Currently assigned
            </span>
          </div>
          <p *ngIf="getDoctors().length === 0" class="no-options">No doctors available</p>
        </td>
      </ng-container>
      <ng-container matColumnDef="nurse">
        <th mat-header-cell *matHeaderCellDef>Assigned Nurse</th>
        <td mat-cell *matCellDef="let p" class="assignment-cell">
          <div *ngIf="getNurses().length > 0" class="assignment-controls">
            <mat-form-field appearance="outline" style="width: 200px;">
              <mat-label>Select Nurse</mat-label>
              <mat-select [value]="p.assignedNurseId ? p.assignedNurseId.toString() : ''" (selectionChange)="assignNurse(p.id, $event.value)">
                <mat-option [value]="''">-- None --</mat-option>
                <mat-option *ngFor="let n of getNurses()" [value]="n.id.toString()">
                  {{ n.username }} ({{ n.email }})
                </mat-option>
              </mat-select>
            </mat-form-field>
            <span *ngIf="p.assignedNurseId" class="assigned-info">
              Currently assigned
            </span>
          </div>
          <p *ngIf="getNurses().length === 0" class="no-options">No nurses available</p>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['id', 'name', 'age', 'doctor', 'nurse']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['id', 'name', 'age', 'doctor', 'nurse']"></tr>
    </table>
  </mat-card>
</div>
